---
title: Redis in action
date: 2019-04-05 12:36:56
categories: [Redis]
tags: [Redis,读书笔记]
---
Redis in action
    4. 数据安全与性能保障
        数据持久化到硬盘
        数据复制到其他机器
        处理系统故障
        Redis事物
        非事物型流水线
        诊断性能问题

        4.1 持久化选项
            4.1.1 快照 snapshotting
                将存在于某一时刻的所有数据都写入硬盘里面

                如果新的快照文件创建完毕之前,Redis,系统或硬件这三者
                之中的任意一个崩溃,那么Redis将丢失最近一次创建快照之后
                写入的所有数据.
                快照持久化只适用于即使丢失一部分数据也不会造成问题的应用程序

                创建快照的方法:
                    客户端向Redis发送bgsave命令来创建一个快照.
                    Redis会调用fork来创建一个子进程,然后子进程负责
                    将快照写入硬盘,父进程继续处理命令请求

                    客户端向Redis发送save命令来创建一个快照.
                    Redis在创建完毕之前不再响应其他任何命令.
                    在没有足够内存的情况,或者等待持久化操作执行完毕
                    也无所谓的情况下 才会使用此命令.

                    如果用户设置了save配置选项.如save 60 10000
                    Redis从最近一次创建快照算起,当60秒之内有10000次
                    写入时,Redis自动触发bgsave

                    Redis接收到shutdown命令或者接收到标准TERM信号时,
                    会执行save命令.save完成后关闭.

                    当一个Redis服务器连接另一个Redis服务器,并向对方发送sync
                    命令来开始一次复制操作时,如果主服务器没有在执行bgsave,或者
                    并非刚刚执行完bgsave,那么主服务器会执行bgsave.

                使用快照持久化的场景:
                    1.个人开发
                        降低快照持久化带来的资源消耗.
                        save 900 1
                        如果距离上次生成快照超过900秒,并在此期间执行了至少
                        一次写入操作.那么触发一次新的bgsave

                    2.对日志进行聚合计算
                        恢复因故障而被中断的日志处理操作




            4.1.2只追加文件 append-only file AOF
                在执行写命令时,将被执行的写命令复制到硬盘里面.以记录数据的变化.
                Redis只要从头到尾重新执行一次AOF文件包含的所有写命令,就可以
                恢复AOF文件所记录的数据集.
                appendonly yes
                appendfsync选项:
                    always
                    everysec
                    no

            4.1.3 重写/压缩AOF文件
                 bgrewriteaof命令会移除aof文件中的冗余命令并重写aof文件,
                 使aof文件体积尽量变小, 工作原理与bgsave相似

        4.2复制
            主服务器向多个从服务器发送更新,并使用从服务器来处理所有的读请求.

            4.2.1  从服务器的配置
                    启动redis服务器时,指定一个包含slaveof host port的配置文件.
                    redis服务器会根据ip和端口来连接主服务器.

                    正在运行的redis服务器,可以发送slaveof no one命令使服务器
                    终止复制操作,不再接受主服务器的数据更新
                    发送 slaveof host port来让服务器开始复制一个新的主服务器.


    5.使用Redis构建支持程序
        使用Redis记录日志
        使用Redis实现计数器并进行数据统计
        查询IP地址所属的城市和国家
        服务的发现和配置

    6.使用Redis构建应用程序组件
        构建两个前缀匹配自动补全程序


        6.1 自动补全最近联系人


    8. 构建简单的社交网站



